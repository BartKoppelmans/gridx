//>>built
define("gridx/modules/Body","dojo/_base/declare dojo/query dojo/_base/array dojo/_base/lang dojo/_base/json dojo/dom-construct dojo/dom-class dojo/_base/Deferred dojo/_base/sniff dojo/keys ../core/_Module dojo/i18n!../nls/Body".split(" "),function(B,q,r,z,A,u,n,x,v,w,C,y){return B(C,{name:"body",forced:["view"],constructor:function(){var a=this,b=a.grid,e=a.domNode=b.bodyNode;a._cellCls={};a.arg("rowHoverEffect")&&n.add(e,"gridxBodyRowHoverEffect");b.emptyNode.innerHTML=a.arg("loadingInfo",y.loadingInfo);
b._connectEvents(e,"_onMouseEvent",a);a.aspect(a.model,"onSet","_onSet");a.aspect(b,"onRowMouseOver","_onRowMouseOver");a.connect(b.mainNode,"onmouseleave",function(){q("\x3e .gridxRowOver",a.domNode).removeClass("gridxRowOver")});a.connect(b.mainNode,"onmouseover",function(d){d.target==b.bodyNode&&q("\x3e .gridxRowOver",a.domNode).removeClass("gridxRowOver")});a.aspect(b,"setStore",function(){a.refresh()})},preload:function(){this._initFocus()},load:function(a){a=this.grid.view;this.aspect(a,"onUpdate",
"lazyRefresh");a._err&&this._loadFail(a._err);this.loaded.callback()},destroy:function(){this.inherited(arguments);this.domNode.innerHTML="";this._destroyed=!0},rowMixin:{node:function(){return this.grid.body.getRowNode({rowId:this.id})}},cellMixin:{node:function(){return this.grid.body.getCellNode({rowId:this.row.id,colId:this.column.id})},contentNode:function(){var a=this.node();return a&&q(".gridxCellContent",a)[0]||a}},rowHoverEffect:!0,stuffEmptyCell:!0,renderWholeRowOnSet:!1,renderStart:0,renderCount:0,
autoUpdate:!0,compareOnSet:function(a,b){return"object"==typeof a&&"object"==typeof b?A.toJson(a)==A.toJson(b):a===b},addClass:function(a,b,e){var d=this._cellCls,d=d[a]=d[a]||{},d=d[b]=d[b]||[];0>r.indexOf(d,e)&&(d.push(e),n.add(this.getCellNode({rowId:a,colId:b}),e))},removeClass:function(a,b,e){var d=this._cellCls[a],c=(d=d&&d[b])&&r.indexOf(d,e);0<=c&&(d.splice(c,1),n.remove(this.getCellNode({rowId:a,colId:b}),e))},getRowNode:function(a){return this.model.isId(a.rowId)&&v("ie")?this._getRowNode(a.rowId):
(a=this._getRowNodeQuery(a))&&q("\x3e "+a,this.domNode)[0]||null},getCellNode:function(a){var b=a.colId,e=this.grid._columns,d=this._getRowNodeQuery(a);return d?(!b&&e[a.colIndex]&&(b=e[a.colIndex].id),b=" [colid\x3d'"+b+"'].gridxCell",this.model.isId(a.rowId)&&v("ie")?(a=this._getRowNode(a.rowId))&&q(b,a)[0]||null:q(d+b,this.domNode)[0]||null):null},refresh:function(a){var b=this,e=b.grid.loadingNode,d=new x;delete b._err;n.add(e,"gridxLoading");b.grid.view.updateVisualCount().then(function(){try{var c=
b.renderStart,f=b.renderCount,g=b.grid.view.visualCount;c+f>g&&(f<g?c=b.renderStart=g-f:(c=b.renderStart=0,f=g));if("number"==typeof a&&0<=a){a=c>a?c:a;var l=c+f-a,k=q('\x3e [visualindex\x3d"'+a+'"]',b.domNode)[0],c=[],f=[];if(k){var h=b._buildRows(a,l,c,f);h&&u.place(h,k,"before")}var m={};for(r.forEach(f,function(a){m[a.id]=1});k;){var s=k.nextSibling,p=k.getAttribute("rowid");if(!m[p])b.onUnrender(p,"refresh");u.destroy(k);k=s}r.forEach(f,b.onAfterRow,b);x.when(b._buildUncachedRows(c),function(){b.onRender(a,
l);b.onForcedScroll();n.remove(e,"gridxLoading");d.callback()})}else b.renderRows(c,f,0,1),b.onForcedScroll(),n.remove(e,"gridxLoading"),d.callback()}catch(t){b._loadFail(t),n.remove(e,"gridxLoading"),d.errback(t)}},function(a){b._loadFail(a);n.remove(e,"gridxLoading");d.errback(a)});return d},refreshCell:function(a,b){var e=new x,d=this,c=d.model,f=d.grid,g=f._columns[b],l=g&&d.getCellNode({visualIndex:a,colId:g.id});if(l){var k,h=f.view.getRowInfo({visualIndex:a}),m=h.rowIndex,s=h.parentId;c.when({start:m,
count:1,parentId:s},function(){if(k=c.byIndex(m,s)){h.rowId=c.indexToId(m,s);var b=f.cell(h.rowId,g.id,1),e=f.tree&&f.tree.isPaddingCell(h.rowId,g.id);l.innerHTML=d._buildCellContent(g,h.rowId,b,a,e);d.onAfterCell(b)}}).then(function(){e.callback(!!k)});return e}e.callback(!1);return e},lazyRefresh:function(){var a=this;clearTimeout(a._sizeChangeHandler);a._sizeChangeHandler=setTimeout(function(){a._destroyed||a.refresh()},10)},renderRows:function(a,b,e,d){var c=this,f=c.grid,g="",l=[],k=[],h=c.domNode,
m=f.emptyNode,s=c.arg("emptyInfo",y.emptyInfo),p="";c._err||(0<b?(m.innerHTML=c.arg("loadingInfo",y.loadingInfo),m.style.zIndex="","top"!=e&&"bottom"!=e&&c.model.free(),g=c._buildRows(a,b,l,k),"top"==e?(c.renderCount+=c.renderStart-a,c.renderStart=a,u.place(g,h,"first"),f.cellWidget&&f.vScroller._updateRowHeight&&(g=c.renderStart+c.renderCount,f=f.vScroller._updateRowHeight("post"),g-f<a+b&&(b=g-f-a))):"bottom"==e?(c.renderCount=a+b-c.renderStart,u.place(g,h,"last"),f.cellWidget&&f.vScroller._updateRowHeight&&
(f.vScroller._updateRowHeight("pre"),c.renderStart>a&&(a=c.renderStart,b=c.renderCount))):(c.renderStart=a,c.renderCount=b,e=d?h.scrollTop:0,h.scrollTop=0,c.onUnrender(),h.innerHTML=g,e&&(h.scrollTop=e),h.scrollLeft=f.hScrollerNode.scrollLeft,p=g?"":s,g||(m.style.zIndex=1)),r.forEach(k,c.onAfterRow,c),x.when(c._buildUncachedRows(l),function(){c._err||(m.innerHTML=p);c.onRender(a,b)})):{top:1,bottom:1}[e]||(h.scrollTop=0,c.onUnrender(),h.innerHTML="",m.innerHTML=s,m.style.zIndex="",c.onEmpty(),c.model.free()))},
unrenderRows:function(a,b){if(0<a){var e=this.model,d=0,c,f=this.domNode;if("post"==b)for(;d<a&&f.lastChild;++d)c=f.lastChild.getAttribute("rowid"),e.free(c),this.onUnrender(c),u.destroy(f.lastChild);else{for(var g=f.scrollTop;d<a&&f.firstChild;++d)c=f.firstChild.getAttribute("rowid"),e.free(c),g-=f.firstChild.offsetHeight,this.onUnrender(c),u.destroy(f.firstChild);this.renderStart+=d;f.scrollTop=0<g?g:0}this.renderCount-=d;e.when()}},onAfterRow:function(){},onAfterCell:function(){},onRender:function(){var a=
this.domNode;9>v("ie")&&a.childNodes.length&&(q("\x3e gridxLastRow",a).removeClass("gridxLastRow"),n.add(a.lastChild,"gridxLastRow"))},onUnrender:function(){},onDelete:function(){},onSet:function(){},onMoveToCell:function(){},onEmpty:function(){},onForcedScroll:function(){},collectCellWrapper:function(){},_getRowNodeQuery:function(a){var b,e=this.model,d=this.grid._escapeId;e.isId(a.rowId)?b="[rowid\x3d'"+d(a.rowId)+"']":"number"==typeof a.rowIndex&&0<=a.rowIndex?b="[rowindex\x3d'"+a.rowIndex+"']"+
(e.isId(a.parentId)?"[parentid\x3d'"+d(a.parentId)+"']":""):"number"==typeof a.visualIndex&&0<=a.visualIndex&&(b="[visualindex\x3d'"+a.visualIndex+"']");return b&&b+".gridxRow"},_getRowNode:function(a){for(var b=0,e=this.domNode.childNodes,d;d=e[b];++b)if(d.getAttribute("rowid")==a)return d;return null},_loadFail:function(a){console.error(a);var b=this.grid.emptyNode;b.innerHTML=this.arg("loadFailInfo",y.loadFailInfo);b.style.zIndex=1;this.domNode.innerHTML="";this._err=a;this.onEmpty()},_buildRows:function(a,
b,e,d){b=a+b;for(var c=[],f=this.grid,g=this.domNode.scrollWidth,l=f.columns();a<b;++a){var k=f.view.getRowInfo({visualIndex:a}),h=f.row(k.rowId,1);c.push('\x3cdiv class\x3d"gridxRow ',a%2?"gridxRowOdd":"",'" role\x3d"row" visualindex\x3d"',a);h?(this.model.keep(h.id),c.push('" rowid\x3d"',h.id,'" rowindex\x3d"',k.rowIndex,'" parentid\x3d"',k.parentId,'"\x3e',this._buildCells(h,a,l),"\x3c/div\x3e"),d.push(h)):(c.push('"\x3e\x3cdiv class\x3d"gridxRowDummy" style\x3d"width:',g,'px;"\x3e\x3c/div\x3e\x3c/div\x3e'),
k.start=k.rowIndex,k.count=1,e.push(k))}return c.join("")},_buildUncachedRows:function(a){var b=this;return a.length&&b.model.when(a,function(){try{r.forEach(a,b._buildRowContent,b)}catch(e){b._loadFail(e)}}).then(null,function(a){b._loadFail(a)})},_buildRowContent:function(a){var b=q('\x3e [visualindex\x3d"'+a.visualIndex+'"]',this.domNode)[0];if(b){var e=this.grid.row(a.rowIndex,0,a.parentId);e?(this.model.keep(e.id),b.setAttribute("rowid",e.id),b.setAttribute("rowindex",a.rowIndex),b.setAttribute("parentid",
a.parentId||""),b.innerHTML=this._buildCells(e,a.visualIndex),this.onAfterRow(e)):console.error("Error in Body._buildRowContent: Row is not in cache: "+a.rowIndex)}},onCheckCustomRow:function(a,b){},onBuildCustomRow:function(a,b){},_buildCells:function(a,b,e){var d=a.id,c=['\x3ctable class\x3d"gridxRowTable" role\x3d"presentation" border\x3d"0" cellpadding\x3d"0" cellspacing\x3d"0"\x3e\x3ctr\x3e'],f={};this.onCheckCustomRow(a,f);if(f[d])f={},this.onBuildCustomRow(a,f),c.push('\x3ctd class\x3d"gridxCustomRow" aria-readonly\x3d"true" role\x3d"gridcell" tabindex\x3d"-1"\x3e',
this._wrapCellData(f[d],d),"\x3c/td\x3e");else for(var f=this.grid,g="body"==f.focus.currentArea()&&this._focusCellRow===b,l=this.model.byId(d).data,k=f._columns,h=this._cellCls[d]||{},m=0,s=k.length;m<s;++m){var p=k[m],t=p.id,n=p.width,q=f.tree&&f.tree.isPaddingCell(d,t),r=p["class"],u=l[t],w=r&&z.isFunction(r),x=p.style&&z.isFunction(p.style),v=(w||x||!q&&p.decorator)&&f.cell(a,e&&e[m]||t,1);c.push('\x3ctd aria-readonly\x3d"true" role\x3d"gridcell" tabindex\x3d"-1" aria-describedby\x3d"',p._domId,
'" colid\x3d"',t,'" class\x3d"gridxCell ',q?"gridxPaddingCell ":"",g&&this._focusCellCol===m?"gridxCellFocus ":"",p._class||""," ",(w?r(v):r)||""," ",h[t]?h[t].join(""):"",' " style\x3d"width:',n,";min-width:",n,";max-width:",n,";",f.getTextDirStyle(t,u),(x?p.style(v):p.style)||"",'"\x3e',this._buildCellContent(p,d,v,b,q,u),"\x3c/td\x3e")}c.push("\x3c/tr\x3e\x3c/table\x3e");return c.join("")},_buildCellContent:function(a,b,e,d,c,f){var g="";f=void 0===f&&e?e.data():f;c||(e=a.decorator?a.decorator(f,
b,d,e):f,g=this._wrapCellData(e,b,a.id));return(""===g||null===g||void 0===g)&&(8>v("ie")||this.arg("stuffEmptyCell"))?"\x26nbsp;":g},_wrapCellData:function(a,b,e){var d=[];this.collectCellWrapper(d,b,e);var c=d.length-1;for(0<c&&d.sort(function(a,b){return(a.priority||0)-(b.priority||0)});0<=c;--c)a=d[c].wrap(a,b,e);return a},_onMouseEvent:function(a,b){var e=this.grid,d="onCell"+a,c="onRow"+a;if(e._isConnected(d)||e._isConnected(c))if(this._decorateEvent(b),b.rowId){if(b.columnId)e[d](b);e[c](b)}},
_decorateEvent:function(a){for(var b=a.target||a.originalTarget,e=this.grid,d;b&&b!=e.bodyNode;b=b.parentNode){d=b.tagName&&b.tagName.toLowerCase();if("td"==d&&n.contains(b,"gridxCell")){var c=e._columnsById[b.getAttribute("colid")];a.cellNode=b;a.columnId=c.id;a.columnIndex=c.index}if("div"==d&&n.contains(b,"gridxRow")){a.rowId=b.getAttribute("rowid");a.parentId=b.getAttribute("parentid");a.rowIndex=parseInt(b.getAttribute("rowindex"),10);a.visualIndex=parseInt(b.getAttribute("visualindex"),10);
break}}},_onSet:function(a,b,e,d){var c=this;if(c.autoUpdate&&e){var f=c.grid,g=f.row(a,1),l=g&&g.node();if(l){var k=e.data,h=d.data;e=f._columns;d=c.arg("renderWholeRowOnSet");var m=c.arg("compareOnSet");d?(l.innerHTML=c._buildCells(g,g.visualIndex()),c.onAfterRow(g),c.onSet(g),c.onRender(b,1)):r.forEach(e,function(b){if(!m(k[b.id],h[b.id])){var d=f.tree&&f.tree.isPaddingCell(a,b.id),e=g.cell(b.id,1);if("auto"===(b.textDir||f.textDir)){var l=f.getTextDir(b.id,e.node().innerHTML);l&&(e.node().style.direction=
l)}e.node().innerHTML=c._buildCellContent(b,a,e,g.visualIndex(),d);c.onAfterCell(e)}})}}},_onRowMouseOver:function(a){var b=q("\x3e div.gridxRowOver",this.domNode)[0];a=this.getRowNode({rowId:a.rowId});b!=a&&(b&&n.remove(b,"gridxRowOver"),a&&n.add(a,"gridxRowOver"))},_focusCellCol:0,_focusCellRow:0,_initFocus:function(){var a=this,b=a.grid,e=b.focus;e.registerArea({name:"body",priority:1,focusNode:a.domNode,scope:a,doFocus:a._doFocus,doBlur:a._blurCell,onFocus:a._onFocus,onBlur:a._blurCell});a.connect(b.mainNode,
"onkeydown",function(d){if("body"==e.currentArea())if(d.keyCode==w.HOME&&!d.ctrlKey)a._focusCellCol=0,a._focusCell(),e.stopEvent(d);else if(d.keyCode==w.END&&!d.ctrlKey)a._focusCellCol=b._columns.length-1,a._focusCell(),e.stopEvent(d);else if(!b.tree||!d.ctrlKey){e._noBlur=1;var c={},f=b.isLeftToRight()?1:-1;c[w.LEFT_ARROW]=[0,-f,d];c[w.RIGHT_ARROW]=[0,f,d];c[w.UP_ARROW]=[-1,0,d];c[w.DOWN_ARROW]=[1,0,d];a._moveFocus.apply(a,c[d.keyCode]||[]);e._noBlur=0}});a.aspect(b,"onCellClick",function(b){a._focusCellRow=
b.visualIndex;a._focusCellCol=b.columnIndex});a.aspect(a,"onRender",function(b,c){a._focusCellRow>=b&&(a._focusCellRow<b+c&&"body"==e.currentArea())&&a._focusCell()});a.connect(b.emptyNode,"onfocus",function(){e.focusArea("body")})},_doFocus:function(a){return this._focusCell(a)||this._focusCell(0,-1,-1)},_focusCell:function(a,b,e){var d=this.grid;d.focus.stopEvent(a);e=0<=e?e:this._focusCellCol;b=0<=b?b:this._focusCellRow;a=d._columns[e].id;var c=this.getCellNode({visualIndex:b,colId:a});if(c)this._blurCell(),
n.add(c,"gridxCellFocus"),this._focusCellRow=b,this._focusCellCol=e,d.header._focusHeaderId=a,8>v("ie")?(b=d.bodyNode.scrollLeft,c.focus(),d.bodyNode.scrollLeft=b):c.focus(),d.hScroller.scrollToColumn(a,c.parentNode.parentNode.parentNode.parentNode);else if(!d.rowCount())return d.emptyNode.focus(),!0;return c},_moveFocus:function(a,b,e){if(a||b){var d,c,f=this,g=f.grid,l=g._columns.length,k=g.view.visualCount;g.focus.stopEvent(e);d=f._focusCellRow+a;d=0>d?0:d>=k?k-1:d;c=f._focusCellCol+b;c=0>c?0:
c>=l?l-1:c;g.vScroller.scrollToRow(d).then(function(){f._focusCell(0,d,c);f.onMoveToCell(d,c,e)})}},_nextCell:function(a,b,e,d){var c=new x,f=this.grid,g=f._columns.length,l=f.view.visualCount;do if(b+=e,0>b||b>=g)a+=e,b=0>b?g-1:0,0>a?(a=l-1,b=g-1):a>=l&&(b=a=0);while(!d(a,b));f.vScroller.scrollToRow(a).then(function(){f.hScroller.scrollToColumn(f._columns[b].id);c.callback({r:a,c:b})});return c},_blurCell:function(){return!!q(".gridxCellFocus",this.domNode).removeClass("gridxCellFocus")},_onFocus:function(a){var b=
this.domNode,e=q(a.target).closest(".gridxCell",b);return e[0]?(a=this.grid._columnsById[e[0].getAttribute("colid")].index,b=parseInt(e.closest(".gridxRow",b)[0].getAttribute("visualindex"),10),this._focusCell(0,b,a)):!1}})});
//@ sourceMappingURL=Body.js.map