//>>built
define("gridx/modules/Edit","dojo/_base/declare dojo/_base/lang dojo/query dojo/_base/json dojo/_base/Deferred dojo/_base/sniff dojo/_base/array dojo/DeferredList dojo/dom-class dojo/dom-style dojo/dom-geometry dojo/dom-construct dojo/keys ../core/_Module dojo/date/locale ../core/model/extensions/Modify dojo/_base/event dijit/form/TextBox".split(" "),function(z,g,l,A,p,v,w,G,B,s,C,t,u,D,q,E,H){function x(a,b,c,d){return a.storePattern&&("date"==a.dataType||"time"==a.dataType)?q.parse(b,a.storePattern):
c}function F(a,b,c,d){return(b=q.parse(d[a],b))?q.format(b,c):d[a]}function y(a){return a&&function(b,c,d){var f=d.gridCellEditField;d=d.cell;var e=d.column.editorArgs;f.set(e&&e.valueField||"value",a(c,b,d,f))}}return z(D,{name:"edit",forced:["cellWidget"],modelExtensions:[E],constructor:function(){this._init()},getAPIPath:function(){return{edit:this}},preload:function(){var a=this,b=a.grid;if(a.arg("lazySave")){var c=function(a){var c=a.node(),e=l(".gridxCellBg",c),k=a.row.id,h=a.column.id,m=a.row.visualIndex();
if(!e.length){e=s.getComputedStyle(c);e=parseInt(C.getPadBorderExtents(c,e).l,10);c=c.clientWidth-e-5;k=["\x3cdiv rowid\x3d'"+k+"' ","colid\x3d'"+h+"' ","class\x3d'gridxCellEditedBg'\x3e\x3cspan\x3e\u25e5\x3c/span\x3e\x3c/div\x3e"].join("");e=t.toDom(k);t.place(e,a.node(),"first");currentLeft=e.offsetLeft;currentLeft+=c;a=l(".gridxRow[visualIndex]",b.bodyNode);var g=0;w.forEach(a,function(a){parseInt(a.getAttribute("visualIndex"),10)<m&&(g+=a.clientHeight)});s.set(e,"left",currentLeft+"px");s.set(e,
"top",g+"px")}};a.connect(b.body,"onAfterRow",function(d){var f=b._columnsById;l(".gridxCell",d.node()).forEach(function(e){e=e.getAttribute("colid");a.model.isChanged(d.id,f[e].field)?(b.body.addClass(d.id,e,"gridxCellChanged"),c(b.cell(d.id,e,1))):b.body.removeClass(d.id,e,"gridxCellChanged")})});a.connect(b.body,"onAfterCell",function(d){d.node();var f=d.row.id,e=d.column.id;d.row.visualIndex();a.model.isChanged(f,b._columnsById[e].field)?(b.body.addClass(f,e,"gridxCellChanged"),c(d)):(b.body.removeClass(f,
e,"gridxCellChanged"),d=d.node(),cellBgNode=l(".gridxCellBg",d),cellBgNode.length&&t.destroy(cellBgNode))})}b.domNode.removeAttribute("aria-readonly");a.connect(b,"onCellDblClick","_onUIBegin");a.connect(b.cellWidget,"onCellWidgetCreated","_onCellWidgetCreated");a.connect(b.cellWidget,"initializeCellWidget",function(a,b){var c=b.column;c.initializeEditor&&a.gridCellEditField&&c.initializeEditor(a.gridCellEditField,b)});a.connect(b.cellWidget,"uninitializeCellWidget",function(a,b){var c=b.column;c.uninitializeEditor&&
a.gridCellEditField&&c.uninitializeEditor(a.gridCellEditField,b)});a.connect(b.cellWidget,"collectCellWidgetConnects",function(a,b){var c=a.cell.column;c.getEditorConnects&&(c=c.getEditorConnects(a,a.cell),b.push.apply(b,c))});a.connect(b.body,"onAfterRow",function(a){l(".gridxCell",a.node()).forEach(function(a){b._columnsById[a.getAttribute("colid")].editable&&a.removeAttribute("aria-readonly")})})},lazySave:!1,load:function(){this._initFocus();this.loaded.callback()},cellMixin:{beginEdit:function(){return this.grid.edit.begin(this.row.id,
this.column.id)},cancelEdit:function(){return this.grid.edit.cancel(this.row.id,this.column.id)},applyEdit:function(){return this.grid.edit.apply(this.row.id,this.column.id)},isEditing:function(){return this.grid.edit.isEditing(this.row.id,this.column.id)},editor:function(){var a=this.grid.cellWidget.getCellWidget(this.row.id,this.column.id);return a&&a.gridCellEditField},isEditable:function(){var a=this.column;return a.isEditable()&&(!a.canEdit||a.canEdit(this))}},columnMixin:{isEditable:function(){return this.grid._columnsById[this.id].editable},
isAlwaysEditing:function(){return this.grid._columnsById[this.id].alwaysEditing},setEditable:function(a){this.grid._columnsById[this.id].editable=!!a;return this},editor:function(){return this.grid._columnsById[this.id].editor},setEditor:function(a,b){this.grid.edit.setEditor(this.id,a,b);return this}},begin:function(a,b){var c=new p,d=this,f=d.grid;if(d.isEditing(a,b))d._record(a,b),d._focusEditor(a,b),c.callback(!0),d.onBegin(f.cell(a,b,1));else{var e=f.row(a,1),k=f._columnsById[b];e&&e.cell(b,
1).isEditable()?(f.cellWidget.setCellDecorator(a,b,d._getDecorator(b),y(k.editorArgs&&k.editorArgs.toEditor||g.partial(x,k))),d._record(a,b),f.body.refreshCell(e.visualIndex(),k.index).then(function(){d._focusEditor(a,b);c.callback(!0);f.resize();d.onBegin(f.cell(a,b,1))})):c.callback(!1)}return c},cancel:function(a,b){var c=new p,d=this,f=d.grid,e=d.model,k=f.row(a,1);if(k){var h=f.cellWidget,g=f._columnsById[b];g&&(g.alwaysEditing?(e=e.byId(a),h=h.getCellWidget(a,b),h.setValue(e.data[b],e.rawData[g.field]),
c.callback(),d.onCancel(f.cell(a,b,1))):(d._erase(a,b),h.restoreCellDecorator(a,b),f.body.refreshCell(k.visualIndex(),g.index).then(function(){c.callback();d.onCancel(f.cell(a,b,1))})))}else c.callback();return c},apply:function(a,b){var c=new p,d=this,f=d.grid,e=f.cell(a,b,1);if(e){var k=f.cellWidget.getCellWidget(a,b),h=k&&k.gridCellEditField;if(h&&(!g.isFunction(h.isValid)||h.isValid())){var m=e.column.editorArgs,h=h.get(m&&m.valueField||"value"),n=function(h,g){h||console.warn("Can not apply change! Error message: ",
g);d._erase(a,b);e.column.alwaysEditing?(c.callback(h),d.onApply(e,h,g,d.arg("lazy"))):(f.cellWidget.restoreCellDecorator(a,b),f.body.refreshCell(e.row.visualIndex(),e.column.index()).then(function(){c.callback(h);f.resize();d.onApply(e,h,g,d.arg("lazy"))}))};try{m&&m.fromEditor?h=m.fromEditor(h,k.cell):e.column.storePattern&&(h=q.format(h,e.column.storePattern)),g.isFunction(e.column.customApplyEdit)?p.when(e.column.customApplyEdit(e,h),function(){n(!0)},function(a){n(!1,a)}):e.rawData()===h?n(!0):
d.arg("lazySave")?(k={},k[f._columnsById[b].field]=h,d.model.set(a,k),n(!0)):p.when(e.setRawData(h),function(){n(!0)},function(a){n(!1,a)})}catch(l){n(!1,l)}return c}}c.callback(!1);return c},isEditing:function(a,b){var c=this.grid._columnsById[b];if(c&&c.alwaysEditing)return!0;c=this.grid.cellWidget.getCellWidget(a,b);return!!c&&!!c.gridCellEditField},setEditor:function(a,b,c){a=this.grid._columnsById[a];var d=a.editorArgs=a.editorArgs||{};a.editor=b;g.mixin(d,c||{})},getLazyData:function(a,b){var c=
this.grid._columnsById[b].field;if(this.arg("lazy")&&(r=this._lazyDataChangeList[a]))return r[c]?r[c].list[r[c].index]:void 0},onBegin:function(){},onApply:function(){},onCancel:function(){},_init:function(){this._editingCells={};this._lazyIds={};this._lazyData={};this._lazyDataChangeList={};this._inCallBackMode=!1;for(var a=0,b=this.grid._columns,c=b.length;a<c;++a){var d=b[a];if(d.storePattern&&d.field&&("date"==d.dataType||"time"==d.dataType)){d.gridPattern=d.gridPattern||!g.isFunction(d.formatter)&&
(g.isObject(d.formatter)||"string"==typeof d.formatter)&&d.formatter||d.storePattern;var f;g.isString(d.storePattern)&&(f=d.storePattern,d.storePattern={},d.storePattern[d.dataType+"Pattern"]=f);d.storePattern.selector=d.dataType;g.isString(d.gridPattern)&&(f=d.gridPattern,d.gridPattern={},d.gridPattern[d.dataType+"Pattern"]=f);d.gridPattern.selector=d.dataType;d.formatter=g.partial(F,d.field,d.storePattern,d.gridPattern)}}this._initAlwaysEdit()},_initAlwaysEdit:function(){var a=this;w.forEach(a.grid._columns,
function(b){if(b.alwaysEditing){b.editable=!0;b.navigable=!0;var c=b.needCellWidget;b.needCellWidget=function(a){return(!c||c.apply(b,arguments))&&a.isEditable()};b.userDecorator=a._getDecorator(b.id);b.setCellValue=y(b.editorArgs&&b.editorArgs.toEditor||g.partial(x,b));b.decorator=a._dummyDecorator;b._cellWidgets={};b._backupWidgets=[]}})},_dummyDecorator:function(a,b,c,d){b=d.column;return!b.needCellWidget||b.needCellWidget(d)?"":a},_getColumnEditor:function(a){a=this.grid._columnsById[a].editor;
return g.isFunction(a)?a.prototype.declaredClass:g.isString(a)?a:"dijit.form.TextBox"},_onCellWidgetCreated:function(a,b){var c=this,d=a.gridCellEditField;if(d&&(b.alwaysEditing&&a.connect(d,"onChange",function(){for(var f=a.domNode.parentNode;f&&!B.contains(f,"gridxRow");)f=f.parentNode;if(f){var e=b.editorArgs&&b.editorArgs.applyDelay||500;clearTimeout(d._timeoutApply);d._timeoutApply=setTimeout(function(){c.apply(f.getAttribute("rowid"),b.id)},e)}}),b.onEditorCreated))b.onEditorCreated(d,b)},_focusEditor:function(a,
b,c){var d=this.grid.cellWidget,f=function(){var e=d.getCellWidget(a,b);((e=e&&e.gridCellEditField)&&!e.focused&&g.isFunction(e.focus)||c)&&e.focus()};v("webkit")?f():setTimeout(f,1)},_getDecorator:function(a){var b=this._getColumnEditor(a);a=this.grid._columnsById[a];var c=a.editorArgs||{},d=c.useGridData,f=c.constraints||{},e=c.props||"",c=a.gridPattern||a.storePattern;a=a.textDir||this.grid.textDir;c&&(f=g.mixin({},c,f));f=A.toJson(f);f=f.substring(1,f.length-1);a?e+=[e?", ":"",'dir: "',this.grid.isLeftToRight()?
"ltr":"rtl",'", textDir: "',a,f?'", ':'"'].join(""):e&&f&&(e+=", ");return function(){return["\x3cdiv data-dojo-type\x3d'",b,"' data-dojo-attach-point\x3d'gridCellEditField' class\x3d'gridxCellEditor gridxHasGridCellValue ",d?"":"gridxUseStoreData","' data-dojo-props\x3d'",e,f,"'\x3e\x3c/div\x3e"].join("")}},_record:function(a,b){var c=this._editingCells,d=c[a];d||(d=c[a]={});d[b]=1},_erase:function(a,b){var c=this._editingCells[a];c&&delete c[b]},_applyAll:function(){var a=this._editingCells,b,c;
for(b in a)for(c in a[b])this.apply(b,c)},_onUIBegin:function(a){this.isEditing(a.rowId,a.columnId)||this._applyAll();return this.begin(a.rowId,a.columnId)},_initFocus:function(){var a=this,b=a.grid,c=b.focus;c?c.registerArea({name:"edit",priority:1,scope:a,doFocus:a._onFocus,doBlur:a._doBlur,onFocus:a._onFocus,onBlur:a._onBlur,connects:[a.connect(b,"onCellKeyDown","_onKey"),a.connect(a,"_focusEditor","_focus")]}):a.connect(b,"onCellMouseDown",function(b){var c=a._editingCells;(!c[b.rowId]||!c[b.rowId][b.columnId])&&
a._applyAll()})},_onFocus:function(a){if(a){var b=l(a.target).closest(".gridxCell",this.grid.bodyNode)[0];return b&&(a=b.getAttribute("colid"),b=b.parentNode.parentNode.parentNode.parentNode.getAttribute("rowid"),this.isEditing(b,a))?(this._record(b,a),!this.grid._columnsById[a].alwaysEditing):!1}return this._editing},_doBlur:function(a,b){var c=this,d=c.grid,f=d.view,e=d.body;if(c._editing&&b){var g=f.getRowInfo({parentId:c.model.parentId(c._focusCellRow),rowIndex:c.model.idToIndex(c._focusCellRow)}).visualIndex;
e._nextCell(g,d._columnsById[c._focusCellCol].index,0<b?1:-1,function(a,b){return d._columns[b].editable}).then(function(b){d.focus.stopEvent(a);c._applyAll();c._focusCellCol=d._columns[b.c].id;var g=f.getRowInfo({visualIndex:b.r});c._focusCellRow=c.model.indexToId(g.rowIndex,g.parentId);e._focusCellCol=b.c;e._focusCellRow=b.r;c.begin(c._focusCellRow,c._focusCellCol)});return!1}return!0},_onBlur:function(){this._applyAll();return!0},_focus:function(a,b){this._editing=!0;this._focusCellCol=b;this._focusCellRow=
a;this.grid.focus.focusArea("edit")},_blur:function(){this._editing=!1;var a=this.grid.focus;a&&(v("ie")?setTimeout(function(){a.focusArea("body")},1):a.focusArea("body"))},_onKey:function(a){var b=this,c=b.grid,d=c._columnsById[a.columnId];if(d.editable){var f=b.isEditing(a.rowId,a.columnId);a.keyCode==u.ENTER?f?b.apply(a.rowId,a.columnId).then(function(c){c&&b._blur();d.alwaysEditing&&b._focusEditor(a.rowId,a.columnId)}):"body"==c.focus.currentArea()&&(c.focus.stopEvent(a),b._onUIBegin(a)):a.keyCode==
u.ESCAPE&&f?b.cancel(a.rowId,a.columnId).then(g.hitch(b,b._blur)).then(function(){c.focus.focusArea("body")}):90==a.keyCode&&a.ctrlKey?b.arg("lazySave")&&b.model.undo():89==a.keyCode&&a.ctrlKey?b.arg("lazySave")&&b.model.redo():83==a.keyCode&&a.ctrlKey&&b.arg("lazySave")&&(b.model.save(),a.preventDefault())}b._editing&&a.keyCode!==u.TAB&&a.stopPropagation()}})});
//@ sourceMappingURL=Edit.js.map