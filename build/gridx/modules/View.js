//>>built
define("gridx/modules/View",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","../core/_Module"],function(s,l,p,q,t){return s(t,{name:"view",load:function(a){var b=this,c=b.model;a=b.grid;var d=a.persist?a.persist.registerAndLoad("tree",function(){return b._openInfo}):{};b._clear();b.aspect(c,"onSizeChange","_onSizeChange");b.aspect(c,"onDelete","_onDelete");b.aspect(a,"setStore",function(){b.arg("clearOnSetStore")&&b._clear()});b._loadLevels(d).then(function(){var a=
b._openInfo[""].count=c.size();b.rootCount=b.rootCount||a-b.rootStart;b.rootStart+b.rootCount>a&&(b.rootCount=a-b.rootStart);for(var f in d)b._expand(f);b._updateVC();b.loaded.callback()},function(a){b._err=a;b.loaded.callback()})},rowMixin:{visualIndex:function(){return this.grid.view.getRowInfo({rowId:this.id}).visualIndex}},rootStart:0,rootCount:0,visualCount:0,getRowInfo:function(a){var b=this.model,c=a.rowId;b.isId(c)&&(a.rowIndex=b.idToIndex(c),a.parentId=b.parentId(c));if("number"==typeof a.rowIndex&&
0<=a.rowIndex)b.isId(a.parentId)||(a.parentId=""),a.visualIndex=this._getVisualIndex(a.parentId,a.rowIndex);else if("number"==typeof a.visualIndex&&0<=a.visualIndex){for(var d=this._openInfo[""].openned,e=this.rootStart+a.visualIndex,f=0;f<d.length;++f){var g=this._openInfo[d[f]];if(b.idToIndex(g.id)<this.rootStart)e+=g.count;else break}for(d={parentId:"",preCount:0};!d.found;)d=this._getChild(e,d);a.rowIndex=d.rowIndex;a.parentId=d.parentId}else return a;a.rowId=b.isId(c)?c:b.indexToId(a.rowIndex,
a.parentId);return a},logicExpand:function(a){var b=this,c=new q;b.model.when({parentId:a,start:0,count:1},function(){b._expand(a)&&b._updateVC()}).then(function(){c.callback()},function(a){c.errback(a)});return c},logicCollapse:function(a){var b=this._openInfo,c=b[a];if(c){var d=this.model.parentId(a),e=this._parentOpenInfo[d],f=c.count;e.splice(l.indexOf(e,a),1);for(c=b[d];c;)c.count-=f,c=b[c.parentId];delete b[a];this.model.free(a,1);this._updateVC()}},updateRootRange:function(a,b,c){var d=this;
d.rootStart=a;d.rootCount=b;return d.updateVisualCount().then(function(){if(!c)d.onUpdate()})},updateVisualCount:function(){var a=this;return a._loadLevels().then(function(){a._updateVC()})},onUpdate:function(){},_parentOpenInfo:null,_openInfo:null,_clear:function(){var a=[];this._openInfo={"":{id:"",parentId:null,path:[],count:0,openned:a}};this._parentOpenInfo={"":a}},_expand:function(a){var b=this.model;if(b.hasChildren(a)){var c=b.parentId(a),d=this._openInfo,e=this._parentOpenInfo,f=e[c]=e[c]||
[];e[a]=e[a]||[];if(!d[a]&&0<=b.idToIndex(a)){b.keep(a,1);0>l.indexOf(f,a)&&f.push(a);for(var f=b.size(a),g=e[a].length-1;0<=g;--g)f+=d[e[a][g]].count;d[a]={id:a,parentId:c,path:b.treePath(a).slice(1).concat([a]),count:f,openned:e[a]};for(a=d[c];a;)a.count+=f,a=d[a.parentId];return 1}}},_getVisualIndex:function(a,b){var c=this.model,d=this._openInfo,e=d[a],f=0,g=""===a?b:c.idToIndex(c.rootId(a));if(e&&g>=this.rootStart&&g<this.rootStart+this.rootCount){for(;e;){f+=b;for(g=0;g<e.openned.length;++g){var h=
d[e.openned[g]],k=c.idToIndex(h.id);if(k<b&&(""!==e.id||k>=this.rootStart))f+=h.count}e.openned.sort(function(a,b){return c.idToIndex(a)-c.idToIndex(b)});b=c.idToIndex(e.id);c.isId(e.id)&&f++;e=d[e.parentId]}return f-this.rootStart}return null},_getChild:function(a,b){var c=this.model,d=this._openInfo[b.parentId],e=b.preCount+c.idToIndex(d.id)+1,f={found:!0,visualIndex:a};d.openned.sort(function(a,b){return c.idToIndex(a)-c.idToIndex(b)});for(var g=0,h=d.openned.length;g<h;++g){var k=d.openned[g],
n=this._openInfo[k],r=c.idToIndex(k),m=r+e;if(m===a)return p.mixin({parentId:d.id,rowIndex:r},f);if(m<a&&m+n.count>=a)return{parentId:k,preCount:e};m+n.count<a&&(e+=n.count)}return p.mixin({parentId:d.id,rowIndex:a-e},f)},_loadLevels:function(a){a=a||this._openInfo;var b=this.model,c=new q,d,e=[];for(d in a)if(b.isId(d)){var f,g=a[d].path;for(f=0;f<g.length;++f)e[f]=e[f]||[],e[f].push({parentId:g[f],start:0,count:1})}var h=function(a){a<e.length?b.when(e[a],function(){l.forEach(e[a],function(a){b.keep(a.parentId,
1)});h(a+1)}).then(null,function(a){c.errback(a)}):b.when({}).then(function(){c.callback()},function(a){c.errback(a)})};h(0);return c},_updateVC:function(){var a=this.model,b=this._openInfo,c=b[""],d=c.openned.length,e=this.rootCount,f,g,h;for(f=0;f<d;++f)g=b[c.openned[f]],h=a.idToIndex(g.id),h>=this.rootStart&&h<this.rootStart+this.rootCount&&(e+=g.count);this.visualCount=e},_onSizeChange:function(a,b){!this.paging&&(0===this.rootStart&&(this.rootCount===b||0>b))&&this.updateRootRange(0,a)},_onDelete:function(a,
b,c){if(c){var d=this._openInfo,e=this._parentOpenInfo;b=d[a];var f=this.model;c=c.pop();var g=1,h=function(a,b){var c=d[a];l.forEach(e[a]||[],function(a){h(a)});delete e[a];if(c)delete d[a],b=c.parentId;else if(!f.isId(b))return;var c=e[b],g=l.indexOf(c,a);0<=g&&c.splice(g,1)};b?(g+=b.count,b=d[b.parentId]):f.isId(c)&&(b=d[c]);for(h(a,c);b;)b.count-=g,b=d[b.parentId];this.visualCount-=g}else this._clear(),this.grid.body.lazyRefresh()}})});
//@ sourceMappingURL=View.js.map