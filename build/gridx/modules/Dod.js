//>>built
define("gridx/modules/Dod","dojo/_base/kernel dojo/dom-construct dojo/dom-style dojo/dom-class dojo/dom-geometry dojo/_base/lang dojo/_base/Deferred ../core/_Module dojo/_base/declare dojo/_base/fx dojo/fx dojo/keys gridx/support/query dijit/a11y dijit/registry dojo/_base/event dojo/_base/sniff".split(" "),function(t,k,f,g,q,r,u,v,w,n,s,l,h,x,y,p,m){t.experimental("gridx/modules/Dod");return w(v,{name:"dod",required:["body"],useAnimation:!0,duration:750,defaultShow:!1,showExpando:!0,preload:function(){this.initFocus()},
load:function(a,b){this._rowMap={};this.connect(this.grid.body,"onAfterCell","_onAfterCell");this.connect(this.grid.body,"onAfterRow","_onAfterRow");this.connect(this.grid.bodyNode,"onclick","_onBodyClick");this.connect(this.grid.body,"onUnrender","_onBodyUnrender");this.connect(this.grid,"onCellKeyDown","_onCellKeyDown");this.connect(this.grid.body,"_onRowMouseOver","_onRowMouseOver");this.grid.columnResizer&&this.connect(this.grid.columnResizer,"onResize","_onColumnResize");this.loaded.callback()},
rowMixin:{showDetail:function(){this.grid.dod.show(this)},hideDetail:function(){this.grid.dod.hide(this)},toggleDetail:function(){this.grid.dod.toggle(this)},refreshDetail:function(){this.grid.dod.refreshDetail(this)},isDetailShown:function(){return this.grid.dod.isShown(this)}},show:function(a){var b=this._row(a),c=this.grid;if(!b.dodShown&&!b.inAnim&&(b.dodShown=!0,a.node())){var d=this._getExpando(a);d&&(d.firstChild.innerHTML="-");var d=a.node(),e=d.scrollWidth;b.dodLoadingNode||(b.dodLoadingNode=
k.create("div",{className:"gridxDodLoadNode",innerHTML:this.grid.nls.loadingInfo}));b.dodNode||(b.dodNode=k.create("div",{className:"gridxDodNode"}));k.place(b.dodLoadingNode,d,"last");k.place(b.dodNode,d,"last");f.set(b.dodLoadingNode,"width",e+"px");f.set(b.dodNode,"width",e+"px");f.set(b.dodNode,"visibility","hidden");f.set(b.dodNode,"overflow","hidden");f.set(b.dodNode,"height","0px");g.add(d,"gridxDodShown");b.dodLoaded?this._detailLoadComplete(a):(f.set(b.dodLoadingNode,"display","block"),c.autoHeight&&
c.vLayout.reLayout(),b.inLoading=!0,this.grid.rowHeader&&(c=h('[rowid\x3d"'+this.grid._escapeId(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0],f.set(c.firstChild,"height",f.get(a.node(),"height")+"px"),f.set(c,"height",f.get(a.node(),"height")+"px")),c=new u,this.arg("detailProvider")?this.detailProvider(this.grid,a.id,b.dodNode,c):c.callback(),c.then(r.hitch(this,"_detailLoadComplete",a),r.hitch(this,"_detailLoadError",a)))}},hide:function(a){var b=this._row(a),c=this.grid,d=c._escapeId;
if(b.dodShown&&!b.inAnim&&!b.inLoading)if(a.node()){g.remove(a.node(),"gridxDodShown");f.set(b.dodLoadingNode,"display","none");if(this.grid.rowHeader){var e=h('[rowid\x3d"'+d(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0];f.set(e.firstChild,"height",f.get(a.node(),"height")-1+"px");f.set(e,"height",f.get(a.node(),"height")-1+"px")}if(e=this._getExpando(a))e.firstChild.innerHTML="+";this.arg("useAnimation")?(b.inAnim=!0,s.wipeOut({node:b.dodNode,duration:this.arg("duration"),onEnd:function(){b.dodShown=
!1;b.inAnim=!1;c.body.onRender()}}).play(),this.grid.rowHeader&&(e=h('[rowid\x3d"'+d(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0],n.animateProperty({node:e.firstChild,duration:this.arg("duration"),properties:{height:{start:e.offsetHeight,end:e.offsetHeight-b.dodNode.scrollHeight,units:"px"}}}).play(),n.animateProperty({node:e,duration:this.arg("duration"),properties:{height:{start:e.offsetHeight,end:e.offsetHeight-b.dodNode.scrollHeight,units:"px"}}}).play())):(b.dodShown=!1,b.inAnim=
!1,this.grid.rowHeader&&(e=h('[rowid\x3d"'+d(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0],e.firstChild.style.height=e.offsetHeight-b.dodNode.scrollHeight+"px",e.style.height=e.offsetHeight-b.dodNode.scrollHeight+"px"),b.dodNode.style.display="none",c.body.onRender());b.defaultShow=!1}else b.dodShown=!1},toggle:function(a){this.isShown(a)?this.hide(a):this.show(a)},refresh:function(a){this._row(a).dodLoaded=!1;this.show(a)},isShown:function(a){return!!this._row(a).dodShown},onShow:function(a){},
onHide:function(a){},initFocus:function(){this.grid.focus.registerArea({name:"navigabledod",priority:1,scope:this,doFocus:this._doFocus,doBlur:this._doBlur,onFocus:this._onFocus,onBlur:this._onBlur,connects:[this.connect(this.grid,"onCellKeyDown","_onCellKeyDown"),this.connect(this.grid,"onRowKeyDown","_onRowKeyDown")]})},_rowMap:null,_lastOpen:null,_row:function(a){var b=a;"object"===typeof a&&(b=a.id);return this._rowMap[b]||(this._rowMap[b]={})},_onBodyClick:function(a){if(!(!g.contains(a.target,
"gridxDodExpando")&&!g.contains(a.target,"gridxDodExpandoText")||this.grid.domNode!=h(a.target).closest(".gridx")[0])){for(a=a.target;a&&!g.contains(a,"gridxRow");)a=a.parentNode;a=a.getAttribute("rowindex");this.toggle(this.grid.row(parseInt(a,10)))}},_onRowMouseOver:function(a){var b=a.target,c=this._rowMap[a.rowId]?this._rowMap[a.rowId].dodNode:void 0;if(c){for(;b&&b!==c;)b=b.parentNode;b&&(g.remove(c.parentNode,"gridxRowOver"),p.stop(a))}},_onAfterRow:function(a){var b=this._row(a);if(this.arg("showExpando")){var c=
h("table",a.node())[0].rows[0].cells[0];k.create("span",{className:"gridxDodExpando",innerHTML:'\x3cspan class\x3d"gridxDodExpandoText"\x3e'+(this.arg("defaultShow")?"-":"+")+"\x3c/span\x3e"},c,"first")}if(this.isShown(a)||this.arg("defaultShow")&&void 0===b.dodShown)b.dodShown=!1,b.defaultShow=!0,this.show(a)},_onBodyUnrender:function(a){if(a&&(a=this._row(a))){var b=a.dodNode;b&&b.parentNode&&b.parentNode.removeChild(b);(a=a.dodLoadingNode)&&a.parentNode&&a.parentNode.removeChild(a)}},_onAfterCell:function(a){this.arg("showExpando")&&
0===a.node().cellIndex&&this._onAfterRow(a.row)},_onColumnResize:function(){h(".gridxDodNode",this.grid.bodyNode).forEach(function(a){f.set(a,"width",a.parentNode.firstChild.offsetWidth+"px")})},_detailLoadComplete:function(a){var b=this._row(a),c=this.grid,d=c._escapeId;if(this.isShown(a)){b.dodLoaded=!0;var e=h(".gridx",b.dodNode);e.length&&(h.isGridInGrid[this.grid.id]=!0);b.defaultShow?(b.dodNode.style.display="block",b.dodNode.style.visibility="visible",b.dodNode.style.height="auto",c.body.onRender(),
this.grid.rowHeader&&(d=h('[rowid\x3d"'+d(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0],d.firstChild.style.height=a.node().firstChild.offsetHeight+b.dodNode.scrollHeight+"px",d.style.height=a.node().firstChild.offsetHeight+b.dodNode.scrollHeight+"px")):("block"==f.get(b.dodLoadingNode,"display")&&(q.setMarginBox(b.dodNode,{h:q.getMarginBox(b.dodLoadingNode).h}),f.set(b.dodNode,"display","block")),this.arg("useAnimation")?(b.inAnim=!0,s.wipeIn({node:b.dodNode,duration:this.arg("duration"),
onEnd:function(){b.inAnim=!1;c.body.onRender()}}).play(),this.grid.rowHeader&&(d=h('[rowid\x3d"'+d(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0],n.animateProperty({node:d.firstChild,duration:this.arg("duration"),properties:{height:{start:d.offsetHeight,end:a.node().firstChild.offsetHeight+b.dodNode.scrollHeight,units:"px"}}}).play(),n.animateProperty({node:d,duration:this.arg("duration"),properties:{height:{start:d.offsetHeight,end:a.node().firstChild.offsetHeight+b.dodNode.scrollHeight,
units:"px"}}}).play())):(b.dodNode.style.display="block",b.dodNode.style.visibility="visible",b.dodNode.style.height="auto",c.body.onRender(),this.grid.rowHeader&&(d=h('[rowid\x3d"'+d(a.id)+'"].gridxRowHeaderRow',this.grid.rowHeader.bodyNode)[0],d.firstChild.style.height=a.node().firstChild.offsetHeight+b.dodNode.scrollHeight+"px",d.style.height=a.node().firstChild.offsetHeight+b.dodNode.scrollHeight+"px")));f.set(b.dodLoadingNode,"display","none");b.inLoading=!1;a=this.grid._nestedGrids=this.grid._nestedGrids?
this.grid._nestedGrids:[];for(d=0;d<e.length;d++){var g=y.byNode(e[d]);a.push(g);g._refreshForDod||(g._refreshForDod=!0,this.connect(g.focus,"tab","_tab"),this.connect(g.lastFocusNode,"onfocus","_lastNodeFocus"),this.connect(g.domNode,"onfocus","_domNodeFocus"))}c.vLayout.reLayout()}},_detailLoadError:function(a){var b=this._row(a);b.dodLoaded=!1;this.isShown(a)&&(b.dodLoadingNode.innerHTML=this.grid.nls.loadFailInfo)},_showLoading:function(a){this._row(a).dodLoadingNode.innerHTML=this.grid.nls.loadingInfo},
_getExpando:function(a){return!this.showExpando?null:(a=h("table",a.node())[0].rows[0].cells[0])?a.firstChild:null},_onCellKeyDown:function(a){var b=this.grid,c=b.focus,b=b.row(a.rowId,1);a.keyCode==l.DOWN_ARROW&&a.ctrlKey?(this.show(b),a.stopPropagation()):a.keyCode==l.UP_ARROW&&a.ctrlKey&&(this.hide(b),a.stopPropagation());if(a.keyCode==l.F4&&!this._navigating&&"body"==c.currentArea()){if(this._beginNavigate(a.rowId,a.columnId)){c.focusArea("navigabledod");if(9>m("ie"))return a.returnValue=!1;p.stop(a)}}else a.keyCode==
l.ESCAPE&&(this._navigating&&"navigabledod"==c.currentArea())&&(this._navigating=!1,c.focusArea("body"))},_onRowKeyDown:function(a){var b=this.grid.focus;a.keyCode==l.ESCAPE&&(this._navigating&&"navigabledod"==b.currentArea())&&(this._navigating=!1,b.focusArea("body"))},_beginNavigate:function(a){var b=this.grid.row(a,1);if(!this._row(a).dodShown)return!1;this._navigating=!0;this._focusRowId=a;a=this._navElems=x._getTabNavigable(b.node());return(a.highest||a.last)&&(a.lowest||a.first)},_tab:function(a,
b){this._step=a},_domNodeFocus:function(a){if(a&&-1===this._step){var b=this._navElems,c=b.lowest||b.first,b=b.highest||b.last||c;(m("ie")?a.srcElement:a.target)==c&&b.focus();return!1}},_lastNodeFocus:function(a){if(a&&1===this._step){var b=this._navElems,c=b.lowest||b.first,b=b.highest||b.last||c;(m("ie")?a.srcElement:a.target)==b&&setTimeout(function(){c.focus()},1);return!1}},_doFocus:function(a,b){if(this._navigating){var c=this._navElems,d=function(){var a=0>b?c.highest||c.last:c.lowest||c.first;
a&&a.focus()};m("webkit")?d():setTimeout(d,5);return!0}return!1},_onFocus:function(a){for(var b=a.target,c=this.grid.domNode;b&&b!==c&&!g.contains(b,"gridxDodNode");)b=b.parentNode;return b&&b!==c&&(c=b.parentNode)?(c=c.getAttribute("rowid"),b!==a.target&&this._beginNavigate(c)):!1},_doBlur:function(a,b){if(a){var c=this._navElems,d=c.lowest||c.first,c=c.highest||c.last||d;(m("ie")?a.srcElement:a.target)==(0<b?c:d)&&p.stop(a);return!1}this._navigating=!1;return!0},_onBlur:function(a){this._navigating=
!1},endFunc:function(){}})});
//@ sourceMappingURL=Dod.js.map