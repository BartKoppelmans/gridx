//>>built
define("gridx/modules/dnd/_Dnd","dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/dom-construct dojo/dom-geometry dojo/dom-class dojo/dom-style dojo/dom dojo/_base/window dojo/_base/sniff dojo/dnd/Source dojo/dnd/Manager ../../core/_Module ../AutoScroll".split(" "),function(r,h,s,k,n,f,t,p,e,u,l,m,q){var g=h.hitch;return q.register(r(q,{name:"_dnd",constructor:function(){var a=this.grid,b=e.doc;this.accept=[];this._profiles={};this._selectStatus={};this._node=k.create("div");this.batchConnect([a,
"onCellMouseOver","_checkDndReady"],[a,"onCellMouseOut","_dismissDndReady"],[a,"onCellMouseDown","_beginDnd"],[b,"onmouseup","_endDnd"],[b,"onmousemove","_onMouseMove"]);this.subscribe("/dnd/cancel","_endDnd")},load:function(a){a=this.grid.mainNode;this._source=new l(a,{isSource:!1,accept:this.accept,getSelectedNodes:function(){return[0]},getItem:g(this,"_getItem"),onSelectStart:function(){this.notSelectText&&l.prototype.onSelectStart.apply(this,arguments)},checkAcceptance:g(this,"_checkAcceptance"),
onDraggingOver:g(this,"_onDraggingOver"),onDraggingOut:g(this,"_onDraggingOut"),onDropExternal:g(this,"_onDropExternal"),onDropInternal:g(this,"_onDropInternal")});u("ff")&&this._fixFF(this._source,a);this._source.grid=this.grid;this._saveSelectStatus();this.loaded.callback()},destroy:function(){this.inherited(arguments);this._source.destroy();k.destroy(this._node)},getAPIPath:function(){return{dnd:{_dnd:this}}},profile:null,register:function(a,b){this._profiles[a]=b;[].push.apply(this.accept,b.arg("accept"))},
_fixFF:function(a){return this.connect(e.doc,"onmousemove",function(b){var c=n.position(a.node),d=b.clientX,f=b.clientY;b=a._alreadyIn;c=f>=c.y&&f<=c.y+c.h&&d>=c.x&&d<=c.x+c.w;!b&&c?(a._alreadyIn=1,a.onOverEvent()):b&&!c&&(a._alreadyIn=0,a.onOutEvent())})},_onMouseMove:function(a){this._alreadyIn&&(this._dnding||this._extDnding)&&this._markTargetAnchor(a)},_saveSelectStatus:function(a){var b,c,d=this.grid.select;if(d)for(b in d)if((c=d[b])&&h.isObject(c))this._selectStatus[b]=c.arg("enabled"),void 0!==
a&&(c.enabled=a)},_loadSelectStatus:function(){var a,b,c=this.grid.select;if(c)for(a in c)if((b=c[a])&&h.isObject(b))b.enabled=this._selectStatus[a]},_checkDndReady:function(a){var b,c;if(!this._dndReady&&!this._dnding&&!this._extDnding)for(b in this._profiles)if(c=this._profiles[b],c.arg("enabled")&&c._checkDndReady(a)){this.profile=c;this._saveSelectStatus(!1);f.add(e.body(),"gridxDnDReadyCursor");this._dndReady=this._source.notSelectText=1;break}},_dismissDndReady:function(){this._dndReady&&(this._loadSelectStatus(),
this._dndReady=0,f.remove(e.body(),"gridxDnDReadyCursor"))},_beginDnd:function(a){var b=this;b._checkDndReady(a);if(b._dndReady){var c=b.profile,d=m.manager();b._source.isSource=!0;b._source.canNotDragOut=!c.arg("provide").length;b._node.innerHTML=c._buildDndNodes();b._oldStartDrag=d.startDrag;d.startDrag=g(b,"_startDrag",a);b.avatar&&(b._oldMakeAvatar=d.makeAvatar,d.makeAvatar=function(){return new b.avatar(d)});d._dndInfo={cssName:c._cssName,count:c._getDndCount()};c._onBeginDnd(b._source);p.setSelectable(b.grid.domNode,
!1)}},_endDnd:function(){var a=m.manager();this._source.isSource=!1;this._alreadyIn=0;delete a._dndInfo;this._oldStartDrag&&(a.startDrag=this._oldStartDrag,delete this._oldStartDrag);this._oldMakeAvatar&&(a.makeAvatar=this._oldMakeAvatar,delete this._oldMakeAvatar);if(this._dndReady||this._dnding||this._extDnding)this._dnding=this._extDnding=0,this._destroyUI(),p.setSelectable(this.grid.domNode,!0),f.remove(e.body(),"gridxDnDReadyCursor"),this.profile._onEndDnd(),this._source.notSelectText=0,this._loadSelectStatus()},
_createUI:function(){f.add(e.body(),"gridxDnDCursor");this.grid.autoScroll&&(this.profile._onBeginAutoScroll(),this.grid.autoScroll.enabled=!0)},_destroyUI:function(){this._unmarkTargetAnchor();f.remove(e.body(),"gridxDnDCursor");this.grid.autoScroll&&(this.profile._onEndAutoScroll(),this.grid.autoScroll.enabled=!1)},_createTargetAnchor:function(){return k.create("div",{"class":"gridxDnDAnchor"})},_markTargetAnchor:function(a){if(this._extDnding||this.profile.arg("canRearrange")){var b=this._targetAnchor,
c=n.position(this.grid.mainNode);b||(b=this._targetAnchor=this._createTargetAnchor(),b.style.display="none",this.grid.mainNode.appendChild(b));f.add(b,"gridxDnDAnchor"+this.profile._cssName);(a=this.profile._calcTargetAnchorPos(a,c))?(t.set(b,a),b.style.display="block"):b.style.display="none"}},_unmarkTargetAnchor:function(){var a=this._targetAnchor;a&&(a.style.display="none",f.remove(a,"gridxDnDAnchor"+this.profile._cssName))},_startDrag:function(a,b,c,d){this._dndReady&&b===this._source&&(this._oldStartDrag.call(m.manager(),
b,this._node.childNodes,d),this._dndReady=0,this._dnding=this._alreadyIn=1,this._createUI(),this._markTargetAnchor(a))},_getItem:function(a){return{type:this.profile.arg("provide"),data:this.profile._getItemData(a)}},_checkAcceptance:function(a,b){var c=function(a){for(var b={},c=a.length-1;0<=c;--c)b[a[c]]=1;return b},d=l.prototype.checkAcceptance;if(d.apply(this._source,arguments)){if(a.grid===this.grid)return this.profile.arg("canRearrange");if(!a.canNotDragOut)for(var f in this._profiles){var e=
this._profiles[f],g=d.apply({accept:c(e.arg("accept"))},arguments);if(e.arg("enabled")&&g&&(!e.checkAcceptance||e.checkAcceptance.apply(e,arguments)))return this.profile=e,this._extDnding=1,!0}}return!1},_onDraggingOver:function(){if(this._dnding||this._extDnding)this._alreadyIn=1,this._createUI()},_onDraggingOut:function(){if(this._dnding||this._extDnding)this._alreadyIn=0,this._destroyUI()},_onDropInternal:function(a,b){this.profile._onDropInternal(a,b)},_onDropExternal:function(a,b,c){var d=this;
b=d.profile._onDropExternal(a,b,c);s.when(b,function(){if(!c)if(a.grid)a.grid.dnd._dnd.profile.onDraggedOut(d._source);else a.deleteSelectedNodes()})}}))});
//@ sourceMappingURL=_Dnd.js.map