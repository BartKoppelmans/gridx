//>>built
define("gridx/modules/Layer","dojo/_base/kernel dojo/_base/declare dojo/_base/lang dojo/dom-class dojo/dom-geometry dojo/query dojo/keys ../core/_Module".split(" "),function(t,u,v,k,p,n,x,w){function r(c,d){for(;c.childNodes.length;)d.appendChild(c.firstChild)}t.experimental("gridx/modules/Layer");var s="__nextLevelButton__";return u(w,{name:"layer",buttonColumnWidth:"20px",constructor:function(){function c(a){var c=a.getAttribute("colid"),c=b.header.getHeaderNode(c);a.style.width=c.style.width;a.style.minWidth=
c.style.minWidth;a.style.maxWidth=c.style.maxWidth}function d(c){c.columnId==s&&c.cellNode.childNodes.length&&(b.focus.focusArea("header"),setTimeout(function(){a.down(c.rowId)},0))}var a=this,b=a.grid,g=a._tmpBodyNode=document.createElement("div"),f=a._contextNode=document.createElement("div"),e=a._wrapper1=document.createElement("div"),h=a._wrapper2=document.createElement("div");g.setAttribute("class","gridxBody");f.setAttribute("class","gridxLayerContext");e.setAttribute("class","gridxLayerWrapper");
h.setAttribute("class","gridxLayerWrapper");a._parentStack=[];a.connect(f,"onmousedown","up");a.aspect(b.columnWidth,"onUpdate",function(){n(".gridxCell",e).forEach(c);n(".gridxCell",h).forEach(c);f.firstChild&&(f.style.height=f.firstChild.offsetHeight+"px")});g=a.arg("buttonColumnWidth");a._col=v.mixin({id:s,headerStyle:"text-align:center;",style:function(a){return"text-align:center;"+(a.model.hasChildren(a.row.id)?"cursor:pointer;":"")},rowSelectable:!1,sortable:!1,filterable:!1,editable:!1,padding:!1,
ignore:!0,declaredWidth:g,width:g,decorator:function(b,c){return a.model.hasChildren(c)?'\x3cdiv class\x3d"gridxLayerHasChildren"\x3e\x3c/div\x3e':""}},a.arg("buttonColumnArgs")||{});a._onSetColumns();a.aspect(b,"setColumns","_onSetColumns");a.aspect(b,"setStore",function(){a._parentStack=[];e.innerHTML=h.innerHTML="";f.firstChild&&(f.removeChild(f.firstChild),f.style.height=0,b.vLayout.reLayout())});b.touch&&a.aspect(b,"onCellTouchStart",d);a.aspect(b,"onCellMouseDown",d)},preload:function(){this.grid.vLayout.register(this,
"_contextNode","headerNode",10)},onReady:function(){},onFinish:function(){},down:function(c){var d=this.model;if(!this._lock&&d.hasChildren(c)&&String(d.parentId(c))===String(d.layerId())){this._lock=1;var a=this.grid,b=a.bodyNode,g=b.offsetWidth,f=this._tmpBodyNode,e=this._wrapper1,h=this._wrapper2,l=a.body.getRowNode({rowId:c}),m=p.position(l),n=p.position(this._contextNode),q=l.cloneNode(!0);k.add(l,"gridxLayerLoading");h.appendChild(q);this._parentStack.push(q);q._pos=a.vScroller.position();this._bodyScrollTop=
b.scrollTop;r(b,f);b.style.left=g+"px";b.style.zIndex=1;f.style.left=0;f.style.zIndex=0;h.style.top=m.y-n.y+"px";h.style.zIndex=-1;a.vScrollerNode.style.zIndex=9999;d.setLayer(c);this._refresh(function(){k.remove(l,"gridxLayerLoading");h.style.zIndex=9999;a.vScroller.scroll(0);k.add(e,"gridxLayerHSlide");k.add(h,"gridxLayerVSlide");b.style.left=0;f.style.left=-g+"px";e.style.left=-g+"px";h.style.top=0},{isDown:!0,rowId:c,parentRowNode:q})}},up:function(){var c=this,d=c.model;if(!c._lock&&d.isId(d.layerId())){c._lock=
1;var a=c.grid,b=a.bodyNode,g=c._tmpBodyNode,f=b.offsetWidth,e=c._wrapper1,h=c._wrapper2,l=c._parentStack[c._parentStack.length-2],m=c._parentStack.pop();parentId=m.getAttribute("rowid");l&&h.appendChild(l);c._bodyScrollTop=b.scrollTop;r(b,g);b.style.left=-f+"px";b.style.zIndex=0;g.style.left=0;g.style.zIndex=1;e.style.top=0;e.style.zIndex=2;h.style.left=-f+"px";a.vScrollerNode.style.zIndex=9999;d.layerUp();c._refresh(function(){if(m){a.vScroller.scroll(m._pos);var d=p.position(a.body.getRowNode({rowId:parentId})),
l=p.position(c._contextNode)}k.add(e,"gridxLayerVSlide");k.add(h,"gridxLayerHSlide");b.style.left=0;g.style.left=f+"px";m&&(e.style.top=d.y-l.y+"px");h.style.left=0},{parentRowNode:m})}},_onSetColumns:function(){var c=this.grid,d=this._col;d.index=c._columns.length;c._columns.push(d);c._columnsById[d.id]=d},_onTransitionEnd:function(){var c=this.model,d=this.grid,a=d.mainNode,b=d.bodyNode,g=this._tmpBodyNode,f=this._contextNode,e=this._wrapper1,h=this._wrapper2;if(this._lock){a.removeChild(g);a.removeChild(e);
f.appendChild(h);f.style.height=h.offsetHeight+"px";k.remove(g,"gridxSlideRefresh");k.remove(b,"gridxSlideRefresh");k.remove(e,"gridxLayerHSlide gridxLayerVSlide");k.remove(h,"gridxLayerHSlide gridxLayerVSlide");e.childNodes.length&&e.removeChild(e.firstChild);a=this._wrapper1;this._wrapper1=this._wrapper2;this._wrapper2=a;e.style.left=0;e.style.zIndex="";e.style.top=0;h.style.left=0;h.style.zIndex="";h.style.top=0;b.style.paddingTop=0;b.style.zIndex="";g.style.paddingTop=0;g.style.zIndex="";d.vScrollerNode.style.zIndex=
"";d.vLayout.reLayout();for(b=0;b<g.childNodes.length;++b)if(e=g.childNodes[b].getAttribute("rowid"),c.isId(e))d.body.onUnrender(e);g.innerHTML="";this._lock=d.body._skipUnrender=0}},_refresh:function(c,d){var a=this,b=a.grid,g=b.bodyNode,f=a._tmpBodyNode,e=document.createDocumentFragment();e.appendChild(f);e.appendChild(a._wrapper1);e.appendChild(a._wrapper2);b.mainNode.appendChild(e);f.scrollTop=a._bodyScrollTop;f.style.paddingTop=a._wrapper1.offsetHeight+"px";g.style.paddingTop=a._wrapper2.offsetHeight+
"px";a._contextNode.style.height=0;a._paging=b.view.paging;b.view.paging=0;b.vLayout.reLayout();d.isDown?n(".gridxLayerHasChildren",d.parentRowNode).removeClass("gridxLayerHasChildren").addClass("gridxLayerLevelUp"):d.parentRowNode&&n(".gridxLayerLevelUp",d.parentRowNode).removeClass("gridxLayerLevelUp").addClass("gridxLayerHasChildren");a.onReady(d);b.body._skipUnrender=1;d.isDown&&(b.vScroller._lock=1);focusEnabled=b.focus.enabled;b.focus.enabled=0;b.body.refresh().then(function(){b.vScroller._lock=
0;b.view.paging=a._paging;setTimeout(function(){k.add(g,"gridxSlideRefresh");k.add(f,"gridxSlideRefresh");b.vScroller._scrollable&&b.vScroller._scrollable.scrollTo({x:0});c();setTimeout(function(){a._onTransitionEnd();b.vLayout.reLayout();b.focus.enabled=focusEnabled;b.body._focusCellRow=0;b.body._focusCellCol=0;b.focus.focusArea("body");a.onFinish(d)},700)},10)})}})});
//@ sourceMappingURL=Layer.js.map