//>>built
define("gridx/core/model/cache/_Cache",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","../_Extension"],function(s,q,m,l,t){var u=m.hitch,r=m.mixin,n=q.indexOf;return s(t,{constructor:function(a,b){this.setStore(b.store);this.columns=m.mixin({},b._columnsById);this._mixinAPI("byIndex","byId","indexToId","idToIndex","size","treePath","rootId","parentId","hasChildren","children","keep","free")},destroy:function(){this.inherited(arguments);this.clear()},setStore:function(a){var b=
this,c=a.fetch;b.destroy();b._cnnts=[];b.store=a;!c&&a.notify?b.aspect(a,"notify",function(a,c){void 0===a?b._onDelete(c):void 0===c?b._onNew(a):b._onSet(a)}):(b.aspect(a,c?"onSet":"put","_onSet"),b.aspect(a,c?"onNew":"add","_onNew"),b.aspect(a,c?"onDelete":"remove","_onDelete"))},clear:function(){this._filled=0;this._priority=[];this._struct={};this._cache={};this._size={};this._struct[""]=[];this._size[""]=-1},byIndex:function(a,b){this._init("byIndex",arguments);return this._cache[this.indexToId(a,
b)]},byId:function(a){this._init("byId",arguments);return this._cache[a]},indexToId:function(a,b){this._init("indexToId",arguments);var c=this._struct[this.model.isId(b)?b:""];return"number"==typeof a&&0<=a?c&&c[a+1]:void 0},idToIndex:function(a){this._init("idToIndex",arguments);var b=this._struct,b=n(b[b[a]&&b[a][0]]||[],a);return 0<b?b-1:-1},treePath:function(a){this._init("treePath",arguments);for(var b=this._struct,c=[];void 0!==a;)c.unshift(a),a=b[a]&&b[a][0];""!==c[0]?c=[]:c.pop();return c},
rootId:function(a){var b=this.treePath(a);return 1<b.length?b[1]:!b.length?null:a},parentId:function(a){return this.treePath(a).pop()},hasChildren:function(a){var b=this.store,c;this._init("hasChildren",arguments);c=this.byId(a);return b.hasChildren&&b.hasChildren(a,c&&c.item)&&b.getChildren},children:function(a){this._init("children",arguments);a=this.model.isId(a)?a:"";for(var b=this._size[a],c=[],e=0;e<b;++e)c.push(this.indexToId(e,a));return c},size:function(a){this._init("size",arguments);var b=
this._size[this.model.isId(a)?a:""];return 0<=b?b:-1},onBeforeFetch:function(){},onAfterFetch:function(){},onLoadRow:function(){},onSetColumns:function(a){var b,c,e,d;this.columns=m.mixin({},a);for(b in this._cache)for(e in c=this._cache[b],a)d=a[e],c.data[e]=this._formatCell(d.id,c.rawData)},_itemToObject:function(a){var b=this.store,c={};return b.fetch?(q.forEach(b.getAttributes(a),function(e){c[e]=b.getValue(a,e)}),c):a},_formatCell:function(a,b){var c=this.columns[a];return c.formatter?c.formatter(b):
b[c.field||a]},_formatRow:function(a){var b=this.columns,c={},e;for(e in b)c[e]=this._formatCell(e,a);return c},_addRow:function(a,b,c,e,d){var g=this._struct,h=this._priority;d=this.model.isId(d)?d:"";var k=g[d];if(!k)throw Error("Fatal error of _Cache._addRow: parent item "+d+" of "+a+" is not loaded");var f=k[b+1];this.model.isId(f)&&f!==a&&console.error("Error of _Cache._addRow: different row id "+a+" and "+k[b+1]+" for same row index "+b);k[b+1]=a;g[a]=g[a]||[d];""===d&&(b=n(h,a),0<=b&&h.splice(b,
1),h.push(a));this._cache[a]={data:this._formatRow(c),rawData:c,item:e};this.onLoadRow(a)},_storeFetch:function(a,b){function c(a){d._size[k]=parseInt(a,10)}function e(b){try{for(var c=a.start||0,e=0,f;f=b[e];++e)d._addRow(g.getIdentity(f),c+e,d._itemToObject(f),f,k);h.callback()}catch(l){h.errback(l)}}var d=this,g=d.store,h=new l,k=d.model.isId(a.parentId)?a.parentId:"",f=r({},d.options||{},a),p=u(h,h.errback);d._filled=1;d.onBeforeFetch(f);""===k?g.fetch?g.fetch(r(f,{onBegin:c,onComplete:e,onError:p})):
(f=g.query(f.query||{},f),l.when(f.total,c),l.when(f,e,p)):d.hasChildren(k)?(f=g.getChildren(d.byId(k).item,f),"total"in f?l.when(f.total,c):l.when(f,function(a){c(a.length)}),l.when(f,e,p)):h.callback();h.then(function(){d.onAfterFetch()});return h},_onSet:function(a){var b=this.store.getIdentity(a),c=this.idToIndex(b),e=this.treePath(b),d=this._cache[b];e.length&&this._addRow(b,c,this._itemToObject(a),a,e.pop());this.onSet(b,c,this._cache[b],d)},_onNew:function(a,b){var c=this.store,e=this._itemToObject(a),
d=b&&b[c.fetch?"item":"parent"];d&&c.getIdentity(d);var g=this._size[""];this.clear();this.onNew(c.getIdentity(a),0,{data:this._formatRow(e),rawData:e,item:a});!d&&0<=g&&(this._size[""]=g+1,this.model._onSizeChange())},_onDelete:function(a){var b=this.store,c=this._struct;a=b.fetch?b.getIdentity(a):a;b=this.treePath(a);if(b.length){var e,d,g,h=[a],k=b[b.length-1],f=this._size,l=f[""],m=n(c[k],a);c[k].splice(m,1);--f[k];for(d=0;d<h.length;++d)if(e=c[h[d]])for(g=e.length-1;0<g;--g)h.push(e[g]);for(d=
h.length-1;0<=d;--d)g=h[d],delete this._cache[g],delete c[g],delete f[g];d=n(this._priority,a);0<=d&&this._priority.splice(d,1);this.onDelete(a,m-1,b);!k&&0<=l&&(f[""]=l-1,this.model._onSizeChange())}else this.clear(),this.onDelete(a)}})});
//@ sourceMappingURL=_Cache.js.map