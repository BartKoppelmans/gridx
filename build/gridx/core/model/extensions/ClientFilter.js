//>>built
define("gridx/core/model/extensions/ClientFilter",["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/Deferred","../_Extension"],function(q,h,l,m,r){var n=l.hitch,k=h.forEach,p=h.indexOf;return q(r,{name:"clientFilter",priority:20,constructor:function(a,b){this.pageSize=b.pageSize||100;this._mixinAPI("filter","hasFilter");a.onFilterProgress=function(){};this.aspect(a,"_msg","_receiveMsg");this.aspect(a,"setStore","clear")},clear:function(){this._ids=0;this._indexes={}},filter:function(a){this.model._addCmd({name:"_cmdFilter",
scope:this,args:arguments,async:1})},hasFilter:function(){return!!this._ids},byIndex:function(a,b){var c=this._ids,d=this.inner,e=c&&c[a];return!this.model.isId(b)&&c?this.model.isId(e)&&d._call("byId",[e]):d._call("byIndex",arguments)},byId:function(a){return this.ids&&void 0===this._indexes[a]?null:this.inner._call("byId",arguments)},indexToId:function(a,b){return!this.model.isId(b)&&this._ids?this._ids[a]:this.inner._call("indexToId",arguments)},idToIndex:function(a){if(this._ids&&""===this.inner._call("parentId",
arguments)){var b=p(this._ids,a);return 0<=b?b:void 0}return this.inner._call("idToIndex",arguments)},size:function(a){return!this.model.isId(a)&&this._ids?this._ids.length:this.inner._call("size",arguments)},when:function(a,b){var c=this,d=function(){c._ids&&c._mapWhenArgs(a);return c.inner._call("when",[a,b])};if(c._refilter&&(c._refilter=0,c._ids)){var e=new m;c._reFilter().then(function(){d().then(n(e,e.callback),n(e,e.errback))});return e}return d()},_cmdFilter:function(){var a=arguments;return this._filter.apply(this,
a[a.length-1])},_filter:function(a){var b=this;b.size();b.clear();if(l.isFunction(a)){var c=[];return b.model.scan({start:0,pageSize:b.pageSize,whenScope:b,whenFunc:b.when},function(d,f){var g,h,k,l=f+d.length;for(g=f;g<l;++g)if(h=b.indexToId(g),k=b.byIndex(g))a(k,h)&&(c.push(h),b._indexes[h]=g);else break}).then(function(){c.length==b.size()?b.clear():(b._ids=c,b.model._msg("filter",c))},0,b.model.onFilterProgress)}var d=new m;d.callback();return d},_mapWhenArgs:function(a){var b=this,c=[],d=b._ids.length;
a.id=h.filter(a.id,function(a){return void 0!==b._indexes[a]});k(a.range,function(a){if(b.model.isId(a.parentId))c.push(a);else{if(!a.count||0>a.count){var f=d-a.start;if(0>=f)return;a.count=f}for(f=0;f<a.count;++f){var g=b._mapIndex(f+a.start);void 0!==g&&c.push({start:g,count:1})}}});a.range=c},_mapMoveArgs:function(a){var b=this;if(3==a.length){for(var c=[],d=a[0],e=a[0]+a[1];d<e;++d)c.push(b._mapIndex(d));a[0]=c;a[1]=b._mapIndex(a[2]);a.pop()}else a[0]=h.map(a[0],function(a){return b._mapIndex(a)}),
a[1]=b._mapIndex(a[1])},_mapIndex:function(a){return this._indexes[this._ids[a]]},_moveFiltered:function(a,b,c){var d=this._ids.length;if(0<=a&&a<d&&0<b&&Infinity>b&&0<=c&&c<d&&(c<a||c>a+b)){var e=[],d=a;for(a+=b;d<a;++d)e.push(this._mapIndex(d));this.inner._call("moveIndexes",[e,this._mapIndex(c)])}},_reFilter:function(){var a=this;return a.inner._call("when",[{id:a._ids,range:[]},function(){k(a._ids,function(b){var c=a.inner._call("idToIndex",[b]);a._indexes[b]=c});a._ids.sort(function(b,c){return a._indexes[b]-
a._indexes[c]})}])},_onMoved:function(a){var b=this;k(b._ids,function(c){var d=b._indexes[c];void 0!==a[d]&&(b._indexes[c]=a[d])});b._ids.sort(function(a,d){return b._indexes[a]-b._indexes[d]})},_receiveMsg:function(a,b){this._ids&&("storeChange"==a?this._refilter=1:"moved"==a?this._onMoved(b):"beforeMove"==a&&this._mapMoveArgs(b))},_onNew:function(a){this._ids&&(this._ids.push(a),this._refilter=1);this.onNew.apply(this,arguments)},_onDelete:function(a,b,c){var d=this._indexes,e=this._ids;if(e){var f=
p(e,a),g=d[a];0<=f&&e.splice(f,1);if(0<=f&&void 0!==g)for(f in b=f,d)d[f]>g&&--d[f];else b=void 0,this._refilter=1}this.onDelete(a,b,c)}})});
//@ sourceMappingURL=ClientFilter.js.map